- hosts: localhost
  gather_facts: no
  collections: [community.vmware]

  vars:
    # === ESXi ===
    esxi_host: "168.121.48.254:10120"
    esxi_user: "{{ esxi_user | default('root') }}"
    esxi_pass: "{{ esxi_pass }}"
    validate_certs: false
    datacenter_name: "ha-datacenter"
    ds_name: "datastore1"

    # Carpeta base en el datastore donde quedarán los backups
    ds_folder_base: "MartinezG01VI/backups"

    # === DÓNDE están los backups en tu laptop ===
    # Usa rutas reales. En Windows puedes usar: C:/Backups/VMs/Bazzite_pc01
    local_vm_backups:
      - name: "Bazzite_pc01"
        local_dir: "/ruta/local/Bazzite_pc01"   # contiene .ovf + .vmdk + (opcional .mf)
      - name: "Windows11pro_pc01"
        local_dir: "/ruta/local/Windows11pro_pc01"
      - name: "WindowsSERVER2022_G01"
        local_dir: "/ruta/local/WindowsSERVER2022_G01"

  tasks:
    - name: Crear carpeta base en el datastore (si no existe)
      community.vmware.vsphere_file:
        hostname: "{{ esxi_host }}"
        username: "{{ esxi_user }}"
        password: "{{ esxi_pass }}"
        datacenter: "{{ datacenter_name }}"
        datastore: "{{ ds_name }}"
        path: "{{ ds_folder_base }}"
        state: directory
        validate_certs: "{{ validate_certs }}"

    - name: Procesar cada VM (crear subcarpeta y subir archivos)
      block:
        - name: Crear subcarpeta por VM en datastore
          community.vmware.vsphere_file:
            hostname: "{{ esxi_host }}"
            username: "{{ esxi_user }}"
            password: "{{ esxi_pass }}"
            datacenter: "{{ datacenter_name }}"
            datastore: "{{ ds_name }}"
            path: "{{ ds_folder_base }}/{{ item.name }}"
            state: directory
            validate_certs: "{{ validate_certs }}"
          loop: "{{ local_vm_backups }}"
          loop_control:
            label: "{{ item.name }}"

        - name: Buscar archivos OVF/VMDK (y .mf si existe) en la laptop
          ansible.builtin.find:
            paths: "{{ item.local_dir }}"
            recurse: no
            patterns: ["*.ovf","*.vmdk","*.mf"]
          register: found_files
          loop: "{{ local_vm_backups }}"
          loop_control:
            label: "{{ item.name }}"

        - name: Subir archivos de cada VM al datastore (OVF/VMDKs)
          community.vmware.vsphere_copy:
            hostname: "{{ esxi_host }}"
            username: "{{ esxi_user }}"
            password: "{{ esxi_pass }}"
            datacenter: "{{ datacenter_name }}"
            src: "{{ file_item.path }}"
            dest: "[{{ ds_name }}] {{ ds_folder_base }}/{{ vm_item.item.name }}/{{ file_item.path | basename }}"
            validate_certs: "{{ validate_certs }}"
            timeout: 7200
            overwrite: true
          loop: "{{ found_files.results | subelements('files', skip_missing=True) }}"
          loop_control:
            label: "{{ (item.1.path | basename) ~ ' -> ' ~ ds_folder_base ~ '/' ~ item.0.item.name }}"
          vars:
            vm_item: "{{ item.0 }}"
            file_item: "{{ item.1 }}"

    - name: Mostrar rutas destino en el datastore
      debug:
        msg:
          - "Subidos a:"
          - "[{{ ds_name }}] {{ ds_folder_base }}/{{ item.name }}/"
      loop: "{{ local_vm_backups }}"
      loop_control:
        label: "{{ item.name }}"
