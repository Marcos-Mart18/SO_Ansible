- name: WS2022
  hosts: ws2022
  gather_facts: no

  vars:
    lan_nic_alias: "Ethernet"            # LAN
    wan_nic_alias: "Ethernet 2"          # WAN
    domain_name: "gamecenter.lan"
    dsrm_password: "{{ ansible_password }}"
    ipv4_lan_ip: "10.10.10.2"
    ipv4_lan_prefix: 24
    ipv4_lan_net: "10.10.10.0"
    ipv4_mask: "255.255.255.0"
    ipv4_router: "10.10.10.1"
    ipv6_addr: "2025:db8:1::2"           # solo referencia; ya está configurada
    ipv6_prefix: 64
    dhcpv4_scope_name: "LANv4"
    dhcpv4_start: "10.10.10.50"
    dhcpv4_end:   "10.10.10.70"
    dhcpv4_lease_days: 7
    dhcpv6_scope_name: "LANv6"
    dhcpv6_prefix: "2025:db8:1::"
    dhcpv6_prefix_len: 64
    dhcpv6_start: "2025:db8:1::50"
    dhcpv6_end:   "2025:db8:1::70"
    nat_name: "NAT44"
    nat_internal_prefix: "{{ ipv4_lan_net }}/{{ ipv4_lan_prefix }}"

  tasks:
    # --- AD DS ---
    - name: Instalar AD DS (si no está)
      ansible.windows.win_feature:
        name: AD-Domain-Services
        include_management_tools: yes
        state: present

    - name: Crear nuevo bosque de Active Directory
      ansible.windows.win_domain:
        dns_domain_name: "{{ domain_name }}"
        safe_mode_password: "{{ dsrm_password }}"
      register: ad_forest

    - name: Reiniciar si AD lo requiere
      ansible.windows.win_reboot:
      when: ad_forest.reboot_required | default(false)

    # --- DNS ---
    - name: Asegurar rol DNS
      ansible.windows.win_feature:
        name: DNS
        include_management_tools: yes
        state: present

    - name: Configurar forwarders DNS
      ansible.windows.win_powershell:
        script: |
          $fw = Get-DnsServerForwarder -ErrorAction SilentlyContinue
          if ($fw) { Remove-DnsServerForwarder -IPAddress ($fw.IPAddress) -Force -ErrorAction SilentlyContinue }
          Add-DnsServerForwarder -IPAddress @("8.8.8.8","1.1.1.1") -PassThru | Out-Null
          Set-Service -Name DNS -StartupType Automatic
          Start-Service DNS

    # --- DHCP + DHCPv4 ---
    - name: Instalar rol DHCP
      ansible.windows.win_feature:
        name: DHCP
        include_management_tools: yes
        state: present

    - name: Autorizar el servidor DHCP en AD
      ansible.windows.win_powershell:
        script: |
          try { Add-DhcpServerInDC -DnsName (Get-ADComputer $env:COMPUTERNAME).DNSHostName -Force } catch {}

    - name: Crear/asegurar scope DHCPv4 + opciones
      ansible.windows.win_powershell:
        script: |
          $net  = [IPAddress]"{{ ipv4_lan_net }}"
          $mask = "{{ ipv4_mask }}"
          $have = Get-DhcpServerv4Scope -ErrorAction SilentlyContinue | Where-Object { $_.ScopeId -eq $net }
          if (-not $have) {
            Add-DhcpServerv4Scope -Name "{{ dhcpv4_scope_name }}" -StartRange "{{ dhcpv4_start }}" -EndRange "{{ dhcpv4_end }}" -SubnetMask $mask -LeaseDuration ([TimeSpan]::FromDays({{ dhcpv4_lease_days }}))
          }
          Set-DhcpServerv4OptionValue -ScopeId "{{ ipv4_lan_net }}" -Router "{{ ipv4_router }}" -DnsServer "{{ ipv4_lan_ip }}" -DnsDomain "{{ domain_name }}" -Force
          Set-Service -Name DHCPServer -StartupType Automatic
          Start-Service DHCPServer

    # --- DHCPv6 completo (sin tocar IPv6 estática) ---
    - name: Poner DNS v6 en la LAN (el propio server)
      ansible.windows.win_powershell:
        script: |
          Set-DnsClientServerAddress -InterfaceAlias "{{ lan_nic_alias }}" -ServerAddresses @("{{ ipv6_addr }}")

    - name: Asegurar binding DHCPv6 (LAN on, WAN off)
      ansible.windows.win_powershell:
        script: |
          $lan = "{{ lan_nic_alias }}"
          $wan = "{{ wan_nic_alias }}"
          $b = Get-DhcpServerv6Binding -ErrorAction SilentlyContinue
          if (-not $b) { return }
          $lanB = $b | Where-Object { $_.InterfaceAlias -eq $lan }
          if ($lanB -and -not $lanB.BindingState) { Set-DhcpServerv6Binding -InterfaceAlias $lan -BindingState $true }
          $wanB = $b | Where-Object { $_.InterfaceAlias -eq $wan }
          if ($wanB -and $wanB.BindingState) { Set-DhcpServerv6Binding -InterfaceAlias $wan -BindingState $false }

    - name: Crear/activar scope DHCPv6 + opciones
      ansible.windows.win_powershell:
        script: |
          $name = "{{ dhcpv6_scope_name }}"
          $prefix = "{{ dhcpv6_prefix }}"
          $len = {{ dhcpv6_prefix_len }}
          $start = "{{ dhcpv6_start }}"
          $end = "{{ dhcpv6_end }}"
          $scope = Get-DhcpServerv6Scope -ErrorAction SilentlyContinue | Where-Object { $_.Prefix -eq $prefix -and $_.PrefixLength -eq $len }
          if (-not $scope) {
            Add-DhcpServerv6Scope -Name $name -Prefix $prefix -PrefixLength $len -StartRange $start -EndRange $end | Out-Null
          }
          Set-DhcpServerv6Scope -Prefix $prefix -PrefixLength $len -State Active
          Set-DhcpServerv6OptionValue -DnsServer @("{{ ipv6_addr }}") -DomainName "{{ domain_name }}" -Force

    - name: Habilitar firewall DHCPv6 e ICMPv6 básico
      ansible.windows.win_powershell:
        script: |
          Enable-NetFirewallRule -DisplayGroup "DHCPv6" -ErrorAction SilentlyContinue
          Enable-NetFirewallRule -DisplayGroup "File and Printer Sharing" -ErrorAction SilentlyContinue
          Enable-NetFirewallRule -DisplayGroup "Core Networking" -ErrorAction SilentlyContinue

    # --- RA/IPv6 (sin router: emitir RA desde el server) ---
    - name: Instalar Remote Access / Routing (RRAS)
      ansible.windows.win_feature:
        name:
          - RemoteAccess
          - Routing
        include_management_tools: yes
        state: present

    - name: Habilitar reenvío IPv6 (router mode)
      ansible.windows.win_powershell:
        script: |
          Set-NetIPInterface -AddressFamily IPv6 -Forwarding Enabled

    - name: Obtener ifIndex de la NIC LAN
      ansible.windows.win_shell: |
        (Get-NetIPInterface -AddressFamily IPv6 -InterfaceAlias "{{ lan_nic_alias }}").ifIndex
      register: lan_ifindex
      changed_when: false

    - name: Habilitar RA en LAN y publicar prefijo + default route (opcional)
      ansible.windows.win_powershell:
        script: |
          $ifIndex = [int]"{{ lan_ifindex.stdout | trim }}"
          $prefix  = "{{ dhcpv6_prefix }}/{{ dhcpv6_prefix_len }}"
          netsh interface ipv6 set interface $ifIndex advertise=enabled | Out-Null
          netsh interface ipv6 add route $prefix $ifIndex publish=yes validlifetime=3600 preferredlifetime=1800 store=active | Out-Null
          # (Opcional) anunciar default route si este server será gateway
          netsh interface ipv6 add route ::/0 $ifIndex publish=yes store=active | Out-Null
          netsh interface ipv6 set interface $ifIndex advertisedefaultroute=enabled | Out-Null

    - name: Deshabilitar advertising en WAN
      ansible.windows.win_powershell:
        script: |
          netsh interface ipv6 set interface "{{ wan_nic_alias }}" advertise=disabled | Out-Null

    # --- NAT IPv4 (SNAT) ---
    - name: Crear NAT44 para salida por WAN
      ansible.windows.win_powershell:
        script: |
          $natName = "{{ nat_name }}"
          $wanIdx  = (Get-NetAdapter -Name "{{ wan_nic_alias }}").ifIndex
          $prefix  = "{{ nat_internal_prefix }}"
          $existing = Get-NetNat -Name $natName -ErrorAction SilentlyContinue
          if ($existing) { Remove-NetNat -Name $natName -Confirm:$false -ErrorAction SilentlyContinue }
          New-NetNat -Name $natName -InternalIPInterfaceAddressPrefix $prefix -ExternalIPInterfaceIndex $wanIdx | Out-Null

    # --- IIS (opcional) ---
    - name: Instalar IIS
      ansible.windows.win_feature:
        name:
          - Web-Server
          - Web-Common-Http
          - Web-Default-Doc
          - Web-Dir-Browsing
          - Web-Http-Errors
          - Web-Static-Content
          - Web-Http-Redirect
          - Web-Health
          - Web-Http-Logging
          - Web-Request-Monitor
          - Web-Stat-Compression
          - Web-Filtering
          - Web-Mgmt-Console
        include_management_tools: yes
        state: present

    - name: Crear web
      ansible.windows.win_copy:
        content: |
          <html><head><title>Servidor Web GameCenter</title></head>
          <body style="font-family:Segoe UI; text-align:center; margin-top:50px;">
          <h1>¡Bienvenido al Servidor Web de GameCenter!</h1>
          <p>Configurado automáticamente con Ansible en Windows Server 2022.</p>
          </body></html>
        dest: "C:\\inetpub\\wwwroot\\index.html"

    # --- WinRM ---
    - name: Asegurar WinRM HTTP permitido
      ansible.windows.win_powershell:
        script: |
          Enable-PSRemoting -Force
          Set-Item WSMan:\localhost\Service\Auth\Basic -Value $true
          Set-Item WSMan:\localhost\Service\AllowUnencrypted -Value $true
          Enable-NetFirewallRule -Name WINRM-HTTP-In-TCP
      changed_when: false

    # --- Verificación ---
    - name: Resumen DHCPv6 / RA
      ansible.windows.win_powershell:
        script: |
          Write-Host "== BINDINGS DHCPv6 =="; Get-DhcpServerv6Binding | ft -AutoSize
          Write-Host "== SCOPE DHCPv6 =="; Get-DhcpServerv6Scope | ft Name,Prefix,PrefixLength,State,StartRange,EndRange -AutoSize
          Write-Host "== OPCIONES DHCPv6 =="; Get-DhcpServerv6OptionValue
          Write-Host "== IF IPv6 (Forwarding) =="; Get-NetIPInterface -AddressFamily IPv6 | ft ifIndex,InterfaceAlias,Forwarding -AutoSize
